{# 
  TABLE COMPONENT MACRO
  =====================
  A reusable table component with customizable columns, data, and actions.
  
  USAGE:
  ------
  1. Import the macro in your template:
     {% from 'components/table/table.html' import table %}
  
  2. Use the table macro:
     {{ table(
         columns=[
             {'key': 'id', 'label': 'ID', 'width': '10%'},
             {'key': 'name', 'label': 'Name', 'width': '40%'}
         ],
         data=items,
         checkbox=True,
         actions=[
             {'type': 'link', 'label': 'View', 'key': 'view_url'},
             {'type': 'button', 'label': 'Delete', 'key': 'delete', 'variant': 'danger'}
         ]
     ) }}
  
  PARAMETERS:
  -----------
  @param columns (required) - List of column definitions
         Each column: {
           'key': 'field_name', 
           'label': 'Display Name', 
           'width': '20%' (optional),
           'sortable': True (optional, enables sorting for this column)
         }
  
  @param data (required) - List of dictionaries containing row data
         Each row should have keys matching column 'key' values
  
  @param checkbox (optional, default=False) - Show checkbox in first column for row selection
  
  @param actions (optional, default=[]) - List of action buttons/links for each row
         Each action: {
             'type': 'link' or 'button',
             'label': 'Button Text',
             'key': 'data_key_for_url' (for links) or 'action_name' (for buttons),
             'variant': 'danger' | 'primary' | 'secondary' (for buttons),
             'icon': 'icon_html' (optional)
         }
  
  @param striped (optional, default=True) - Alternate row colors
  
  @param hover (optional, default=True) - Highlight row on hover
  
  @param empty_message (optional, default="No data available") - Message when no data
  
  @param per_page (optional, default=10) - Number of rows per page
  
  @param show_pagination (optional, default=True) - Show pagination controls
  
  @param table_id (optional) - Unique ID for the table (required if using multiple tables on same page)
  
  @param title (optional) - Title to display above the table (on left side of rows selector)
  
  EXAMPLES:
  ---------
  # Simple table with checkboxes
  {{ table(
      columns=[
          {'key': 'genius_section_id', 'label': 'Genius Section ID'},
          {'key': 'section_name', 'label': 'Section Name'},
          {'key': 'term', 'label': 'Term'}
      ],
      data=sections,
      checkbox=True
  ) }}
  
  # Table with remove action
  {{ table(
      columns=[
          {'key': 'genius_section_id', 'label': 'Genius Section ID'},
          {'key': 'tag_category', 'label': 'Tag Category'},
          {'key': 'tag_value', 'label': 'Tag Value'}
      ],
      data=tags,
      checkbox=True,
      actions=[
          {'type': 'icon', 'label': 'Remove Tag', 'key': 'remove', 'icon': 'üóëÔ∏è'}
      ]
  ) }}
#}

{% macro table(columns, data, checkbox=False, actions=[], striped=True, hover=True, empty_message="No data available", per_page=10, show_pagination=True, table_id='', title='') %}
{% set unique_id = table_id if table_id else 'table_' ~ range(1000, 9999) | random %}
<div class="table-wrapper" id="wrapper_{{ unique_id }}">
  {% if show_pagination and data and data|length > 0 %}
  <div class="table-controls">
    {% if title %}
    <h2 class="table-title">{{ title }}</h2>
    {% else %}
    <div></div>
    {% endif %}
    <div class="rows-per-page">
      <label for="rows_{{ unique_id }}">Show</label>
      <select id="rows_{{ unique_id }}" class="rows-select">
        <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
        <option value="25" {{ 'selected' if per_page == 25 }}>25</option>
        <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
        <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
        <option value="{{ data|length }}">All</option>
      </select>
      <span>rows</span>
    </div>
  </div>
  {% endif %}

<div class="table-container">
  <table class="data-table {{ 'table-striped' if striped }} {{ 'table-hover' if hover }}">
    <thead>
      <tr>
        {% if checkbox %}
        <th class="checkbox-col">
          <input type="checkbox" class="select-all-checkbox" aria-label="Select all rows">
        </th>
        {% endif %}
        
        {% for col in columns %}
        <th {% if col.width %}style="width: {{ col.width }}"{% endif %} 
            {% if col.get('sortable', False) %}class="sortable" data-column="{{ col.key }}"{% endif %}>
          <div class="th-content">
            {{ col.label }}
            {% if col.get('sortable', False) %}
            <span class="sort-icon">
              <svg width="12" height="16" viewBox="0 0 12 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path class="sort-asc" d="M6 4L3 7H9L6 4Z" fill="currentColor" opacity="0.3"/>
                <path class="sort-desc" d="M6 12L9 9H3L6 12Z" fill="currentColor" opacity="0.3"/>
              </svg>
            </span>
            {% endif %}
          </div>
        </th>
        {% endfor %}
        
        {% if actions %}
        <th class="actions-col">{{ actions[0].column_label if actions[0].column_label else '' }}</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% if data and data|length > 0 %}
        {% for row in data %}
        <tr>
          {% if checkbox %}
          <td class="checkbox-col">
            <input type="checkbox" class="row-checkbox" name="selected_rows" value="{{ row.get('id') or row.get(columns[0].key) }}" aria-label="Select row">
          </td>
          {% endif %}
          
          {% for col in columns %}
          <td {% if col.key == 'ID' or col.key == 'Value' or col.key == 'tag_name' %}data-tag-id="{{ row.get('tag_entry_id', row.get('tag_id', row.get('id', row.get('ID', '')))) }}"{% endif %}
              {% if col.key == 'Value' %}data-tag-value="{{ row.get('tag_value', row.get('Value', '')) }}"{% endif %}
              {% if col.key == 'tag_name' %}data-tag-name="{{ row.get('tag_name_hidden', row.get('tag_name', '')) }}"{% endif %}>
            {% if col.get('format') == 'tag' %}
              {% if row.get(col.key) and row.get(col.key) != '-' %}
                <span class="tag-badge">{{ row.get(col.key, '') }}</span>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            {% elif col.get('format') == 'link' %}
              <a href="{{ row.get(col.key + '_url', '#') }}" class="table-link">{{ row.get(col.key, '') }}</a>
            {% else %}
              {{ row.get(col.key, '') }}
            {% endif %}
          </td>
          {% endfor %}
          
          {% if actions %}
          <td class="actions-col">
            {% for action in actions %}
              {% if action.type == 'link' %}
                {% if action.get('onclick') %}
                  {% set onclick_str = action.onclick %}
                  {# Replace all row.FIELD with actual values #}
                  {% for key, value in row.items() %}
                    {% set placeholder = 'row.' + key %}
                    {% if placeholder in onclick_str %}
                      {% set value_str = value|string %}
                      {# Check if it's a pure number #}
                      {% if value_str.isdigit() or (value_str.replace('-', '', 1).isdigit() and value_str.startswith('-')) %}
                        {# It's a number, don't quote it #}
                        {% set onclick_str = onclick_str|replace(placeholder, value_str) %}
                      {% else %}
                        {# It's a string, quote and escape it #}
                        {% set escaped_value = value_str|replace("'", "\\'") %}
                        {% set onclick_str = onclick_str|replace(placeholder, "'" + escaped_value + "'") %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  <a href="javascript:void(0)" onclick="{{ onclick_str }}" class="{{ action.get('class', 'action-link') }}" title="{{ action.get('title', '') }}">{{ action.get('text', action.get('label', ''))|safe }}</a>
                {% else %}
                  <a href="{{ row.get(action.key, '#') }}" class="{{ action.get('class', 'action-link') }}" title="{{ action.get('title', '') }}">{{ action.get('text', action.get('label', ''))|safe }}</a>
                {% endif %}
              {% elif action.type == 'button' %}
                <button type="button" 
                        class="{{ action.get('class', 'action-btn action-btn-' ~ action.get('variant', 'primary')) }}" 
                        data-action="{{ action.get('action', action.get('key', '')) }}"
                        data-id="{{ row.get('id') or row.get('tag_id') or row.get(columns[0].key) }}"
                        title="{{ action.get('title', action.get('label', '')) }}">
                  {% if action.get('icon') %}
                    {{ action.icon|safe }}
                  {% else %}
                    {{ action.get('label', 'Action') }}
                  {% endif %}
                </button>
              {% elif action.type == 'icon' %}
                <button type="button" 
                        class="action-icon" 
                        data-action="{{ action.key }}"
                        data-id="{{ row.get('id') or row.get(columns[0].key) }}"
                        title="{{ action.label }}">
                  {% if action.get('icon') %}
                    {{ action.icon|safe }}
                  {% else %}
                    √ó
                  {% endif %}
                </button>
              {% endif %}
            {% endfor %}
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="{{ columns|length + (1 if checkbox else 0) + (1 if actions else 0) }}" class="empty-state">
            {{ empty_message }}
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if show_pagination and data and data|length > 0 %}
<div class="pagination-container">
  <div class="pagination-info">
    Showing <span class="pagination-start">1</span> to <span class="pagination-end">{{ [per_page, data|length]|min }}</span> of <span class="pagination-total">{{ data|length }}</span> entries
  </div>
  <div class="pagination-controls" id="pagination_{{ unique_id }}">
    <!-- Pagination buttons will be generated by JavaScript -->
  </div>
</div>
{% endif %}

</div>

<style>
  .table-wrapper {
    width: 100%;
  }

  .table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 0 4px;
  }

  .table-title {
    font-family: 'Poppins', sans-serif;
    font-size: 24px;
    font-weight: 600;
    color: #0021A5;
    margin: 0;
  }

  .rows-per-page {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    color: #4A4A4A;
  }

  .rows-select {
    padding: 6px 12px;
    border: 1px solid #D1D5DB;
    border-radius: 4px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    color: #4A4A4A;
    background: white;
    cursor: pointer;
  }

  .rows-select:focus {
    outline: none;
    border-color: #0021A5;
  }

  .table-container {
    width: 100%;
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
  }

  .data-table thead {
    background: #002657;
  }

  .data-table thead th {
    color: #FFFFFF;
    font-weight: 600;
    text-align: left;
    padding: 16px 12px;
    border: none;
  }

  .data-table thead th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
  }

  .data-table thead th.sortable:hover {
    background: #003580;
  }

  .th-content {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sort-icon {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
  }

  .sortable:hover .sort-icon {
    opacity: 1;
  }

  .sortable.sort-asc .sort-asc {
    opacity: 1 !important;
  }

  .sortable.sort-desc .sort-desc {
    opacity: 1 !important;
  }

  .data-table tbody tr {
    border-bottom: 1px solid #E5E5E5;
  }

  .data-table tbody td {
    padding: 14px 12px;
    color: #4A4A4A;
  }

  /* Striped rows */
  .data-table.table-striped tbody tr:nth-child(even) {
    background: #F9FAFB;
  }

  /* Hover effect */
  .data-table.table-hover tbody tr:hover {
    background: #F3F4F6;
  }

  /* Checkbox column */
  .checkbox-col {
    width: 40px;
    text-align: center;
  }

  .checkbox-col input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  /* Actions column */
  .actions-col {
    width: 120px;
    text-align: right;
    padding: 12px;
    display: flex;
    justify-content: space-around;
  }

  /* Action buttons */
  .action-btn {
    padding: 8px;
    border: none;
    border-radius: 4px;
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    outline: none;
  }

  .action-btn:focus {
    outline: none;
  }

  .action-link-edit {
    color: #0021A5;
    transition: all 0.2s ease;
    padding: 8px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    outline: none;
  }

  .action-link-edit:hover {
    background: #EEF2FF;
    color: #001580;
  }

  .action-link-delete {
    color: #DC2626;
    transition: all 0.2s ease;
    padding: 8px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    outline: none;
  }

  .action-link-delete:hover {
    background: #FEE2E2;
    color: #B91C1C;
  }

  .action-btn-primary {
    background: #0021A5;
    color: white;
  }

  .action-btn-primary:hover {
    background: #001580;
  }

  .action-btn-danger {
    background: #DC2626;
    color: white;
  }

  .action-btn-danger:hover {
    background: #B91C1C;
  }

  .action-btn-secondary {
    background: #6C757D;
    color: white;
  }

  .action-btn-secondary:hover {
    background: #5a6268;
  }

  /* Icon action button */
  .action-icon {
    background: transparent;
    border: none;
    color: #DC2626;
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    transition: all 0.2s ease;
  }

  .action-icon:hover {
    color: #B91C1C;
    transform: scale(1.1);
  }

  /* Tag badge */
  .tag-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: #EEF2FF;
    color: #0021A5;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    gap: 4px;
  }

  .tag-badge::before {
    content: 'üè∑Ô∏è';
    font-size: 14px;
  }

  /* Table link */
  .table-link {
    color: #0021A5;
    text-decoration: none;
  }

  .table-link:hover {
    text-decoration: underline;
  }

  /* Action links */
  .action-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    margin: 0 8px;
    color: #6B7280;
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .action-link:hover {
    background: #F3F4F6;
  }

  .action-link-edit {
    color: #0021A5;
  }

  .action-link-edit:hover {
    color: #001580;
    background: #EEF2FF;
  }

  .action-link svg {
    display: block;
  }

  .table-link:hover {
    text-decoration: underline;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 40px 20px !important;
    color: #9CA3AF;
    font-style: italic;
  }

  /* Text muted */
  .text-muted {
    color: #9CA3AF;
  }

  /* Pagination */
  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
    padding: 0 4px;
    font-family: 'IBM Plex Sans', sans-serif;
  }

  .pagination-info {
    font-size: 14px;
    color: #4A4A4A;
  }

  .pagination-info span {
    font-weight: 600;
  }

  .pagination-controls {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .pagination-btn {
    padding: 8px 12px;
    border: 1px solid #D1D5DB;
    background: white;
    color: #4A4A4A;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
    min-width: 40px;
    text-align: center;
  }

  .pagination-btn:hover:not(:disabled) {
    background: #F3F4F6;
    border-color: #0021A5;
    color: #0021A5;
  }

  .pagination-btn.active {
    background: #0021A5;
    color: white;
    border-color: #0021A5;
  }

  .pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination-ellipsis {
    padding: 8px 4px;
    color: #9CA3AF;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .data-table {
      font-size: 12px;
    }

    .data-table thead th,
    .data-table tbody td {
      padding: 10px 8px;
    }

    .action-btn {
      padding: 4px 8px;
      font-size: 11px;
    }

    .pagination-container {
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
    }

    .pagination-info {
      font-size: 12px;
    }

    .pagination-btn {
      padding: 6px 10px;
      font-size: 12px;
      min-width: 36px;
    }
  }
</style>

<script>
  // Table pagination functionality
  (function() {
    const tableId = '{{ unique_id }}';
    const wrapper = document.getElementById('wrapper_' + tableId);
    if (!wrapper) return;

    const table = wrapper.querySelector('.data-table tbody');
    const rowsSelect = wrapper.querySelector('.rows-select');
    const paginationContainer = wrapper.querySelector('#pagination_' + tableId);
    const paginationInfo = wrapper.querySelector('.pagination-info');
    const sortableHeaders = wrapper.querySelectorAll('.sortable');
    
    if (!table) return;

    let allRows = Array.from(table.querySelectorAll('tr')).filter(row => !row.querySelector('.empty-state'));
    const totalRows = allRows.length;
    
    let currentPage = 1;
    let rowsPerPage = parseInt('{{ per_page }}') || 10;
    let sortColumn = null;
    let sortDirection = 'asc';

    // Sorting functionality
    sortableHeaders.forEach(header => {
      header.addEventListener('click', function() {
        const column = this.getAttribute('data-column');
        
        // Toggle sort direction
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }

        // Update header UI
        sortableHeaders.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
        });
        this.classList.add('sort-' + sortDirection);

        // Sort rows
        sortRows(column, sortDirection);
        currentPage = 1;
        showPage(1);
      });
    });

    function sortRows(column, direction) {
      const columnIndex = Array.from(wrapper.querySelectorAll('.data-table thead th')).findIndex(
        th => th.getAttribute('data-column') === column
      );

      allRows.sort((a, b) => {
        const aCell = a.querySelectorAll('td')[columnIndex];
        const bCell = b.querySelectorAll('td')[columnIndex];
        
        if (!aCell || !bCell) return 0;

        let aValue = aCell.textContent.trim();
        let bValue = bCell.textContent.trim();

        // Try to parse as numbers
        const aNum = parseFloat(aValue.replace(/,/g, ''));
        const bNum = parseFloat(bValue.replace(/,/g, ''));

        if (!isNaN(aNum) && !isNaN(bNum)) {
          return direction === 'asc' ? aNum - bNum : bNum - aNum;
        }

        // Try to parse as dates
        const aDate = new Date(aValue);
        const bDate = new Date(bValue);

        if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
          return direction === 'asc' ? aDate - bDate : bDate - aDate;
        }

        // Default string comparison
        return direction === 'asc' 
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue);
      });

      // Re-append rows in sorted order
      allRows.forEach(row => table.appendChild(row));
    }

    function showPage(page) {
      currentPage = page;
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;

      allRows.forEach((row, index) => {
        if (index >= start && index < end) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      // Update pagination info
      if (paginationInfo) {
        const startNum = totalRows > 0 ? start + 1 : 0;
        const endNum = Math.min(end, totalRows);
        paginationInfo.querySelector('.pagination-start').textContent = startNum;
        paginationInfo.querySelector('.pagination-end').textContent = endNum;
        paginationInfo.querySelector('.pagination-total').textContent = totalRows;
      }

      renderPagination();
    }

    function renderPagination() {
      if (!paginationContainer) return;

      const totalPages = Math.ceil(totalRows / rowsPerPage);
      let html = '';

      // Previous button
      html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="tablePagination_${tableId}.goToPage(${currentPage - 1})">Previous</button>`;

      // Page numbers
      const maxButtons = 7;
      let startPage = 1;
      let endPage = totalPages;

      if (totalPages > maxButtons) {
        if (currentPage <= 4) {
          endPage = maxButtons - 1;
        } else if (currentPage >= totalPages - 3) {
          startPage = totalPages - (maxButtons - 2);
        } else {
          startPage = currentPage - 2;
          endPage = currentPage + 2;
        }
      }

      if (startPage > 1) {
        html += `<button class="pagination-btn" onclick="tablePagination_${tableId}.goToPage(1)">1</button>`;
        if (startPage > 2) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="tablePagination_${tableId}.goToPage(${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
        html += `<button class="pagination-btn" onclick="tablePagination_${tableId}.goToPage(${totalPages})">${totalPages}</button>`;
      }

      // Next button
      html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="tablePagination_${tableId}.goToPage(${currentPage + 1})">Next</button>`;

      paginationContainer.innerHTML = html;
    }

    // Rows per page change
    if (rowsSelect) {
      rowsSelect.addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        showPage(1);
      });
    }

    // Global pagination controller
    window['tablePagination_' + tableId] = {
      goToPage: function(page) {
        if (page >= 1 && page <= Math.ceil(totalRows / rowsPerPage)) {
          showPage(page);
        }
      }
    };

    // Initialize
    if (totalRows > 0) {
      showPage(1);
    }
  })();

  // Select all checkbox functionality
  document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');
    
    selectAllCheckboxes.forEach(function(selectAll) {
      selectAll.addEventListener('change', function() {
        const table = this.closest('table');
        const checkboxes = table.querySelectorAll('.row-checkbox');
        checkboxes.forEach(function(checkbox) {
          checkbox.checked = selectAll.checked;
        });
      });
    });

    // Update select-all when individual checkboxes change
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    rowCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const table = this.closest('table');
        const selectAll = table.querySelector('.select-all-checkbox');
        const allCheckboxes = table.querySelectorAll('.row-checkbox');
        const checkedCount = table.querySelectorAll('.row-checkbox:checked').length;
        
        selectAll.checked = checkedCount === allCheckboxes.length;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
      });
    });
  });
</script>
{% endmacro %}
