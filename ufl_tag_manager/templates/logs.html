{% extends 'tags_base.html' %}
{% block title %}Report Logs{% endblock %}
{% block content %}

<style>
  .container.mt-4 {
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  .logs-page {
    padding: 20px 40px 60px;
    width: 90vw;
    max-width: 90vw;
    margin: 0 auto;
    overflow-x: visible;
  }

  .table-wrapper {
    overflow-x: visible !important;
  }

  .page-header {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 48px;
  }

  .page-header-divider {
    width: 4px;
    height: 60px;
    background: #FA4616;
  }

  .page-title {
    font-family: 'Poppins', sans-serif;
    font-size: 48px;
    font-weight: 700;
    color: #002657;
    margin: 0;
  }

  .alert {
    position: relative;
    padding: 16px 24px;
    padding-right: 48px;
    border-radius: 4px;
    margin-bottom: 24px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    animation: slideIn 0.3s ease-out;
  }

  .alert.success {
    background-color: #D1FAE5;
    color: #065F46;
    border: 1px solid #A7F3D0;
  }

  .alert.danger {
    background-color: #FEE2E2;
    color: #991B1B;
    border: 1px solid #FECACA;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .alert-close {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    color: inherit;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .alert-close:hover {
    opacity: 1;
  }

  .back-link {
    color: #0021A5;
    text-decoration: none;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
  }

  .back-link:hover {
    background-color: #F3F4F6;
    color: #001580;
  }

  pre.codebox {
    margin-top: 24px;
    background: #0b1020;
    color: #e5e7eb;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 13px;
    line-height: 1.5;
    font-family: 'Courier New', monospace;
  }

  .detail-info {
    margin: 16px 0;
    padding: 12px;
    background: #F3F4F6;
    border-radius: 4px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    color: #6B7280;
  }

  .view-link {
    color: #0021A5;
    text-decoration: none;
    font-weight: 500;
    padding: 6px 16px;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 13px;
    display: inline-block;
    border: 1px solid #0021A5;
    background: white;
    margin-right: 8px;
    white-space: nowrap;
  }

  .view-link:hover {
    background-color: #0021A5;
    color: white;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
  }

  .status-success {
    background-color: #D1FAE5;
    color: #065F46;
  }

  .status-failed {
    background-color: #FEE2E2;
    color: #991B1B;
  }

  .status-icon {
    width: 16px;
    height: 16px;
  }

  @media (max-width: 768px) {
    .logs-page {
      padding: 24px 20px;
    }
  }
</style>

<div class="logs-page">

  {% if view == "detail" %}
    <p><a href="{{ base_path }}/logs{{ ext }}" class="back-link">&larr; Back to all reports</a></p>

    <div class="page-header">
      <div class="page-header-divider"></div>
      <h1 class="page-title">Log Details</h1>
    </div>

    <!-- {% if detail_key %}
      <div class="detail-info">
        <strong>Log Key:</strong> <code>{{ detail_key }}</code>
      </div>
    {% endif %} -->

    <pre class="codebox">{{ content }}</pre>

  {% else %}

    {% if view == "summary" %}
      <div class="page-header">
        <div class="page-header-divider"></div>
        <h1 class="page-title">Report Logs</h1>
      </div>
    {% else %}
      <div class="page-header">
        <div class="page-header-divider"></div>
        <h1 class="page-title">Report History: {{ report_name }}</h1>
      </div>
      <p><a href="{{ base_path }}/logs{{ ext }}" class="back-link">&larr; Back to all reports</a></p>
    {% endif %}

    {% if messages %}
      {% for cat, msg in messages %}
        <div class="alert {{ cat }}" data-alert>
          <button class="alert-close" data-close-alert>&times;</button>
          {{ msg }}
        </div>
      {% endfor %}
    {% endif %}

    {% from 'components/table/table.html' import table %}
    
    {% if rows and rows|length > 0 %}
      {% set processed_rows = [] %}
      {% for row in rows %}
        {% set _ = processed_rows.append({
          'report_name': row.report_name or 'Unknown',
          'description': row.description or '-',
          'start_time': row.start_time or '-',
          'end_time': row.end_time or '-',
          'result': row.result or '-',
          'result_raw': row.result,
          'details_url': row.details_url if row.details_url else '',
          'history_url': base_path + '/logs' + ext + '?report=' + (row.report_name|urlencode) if view == 'summary' else ''
        }) %}
      {% endfor %}
      
      {% if view == "summary" %}
        {{ table(
          columns=[
            {'key': 'report_name', 'label': 'Report Name', 'width': '8%'},
            {'key': 'description', 'label': 'Description', 'width': '16%'},
            {'key': 'start_time', 'label': 'Start Time', 'width': '11%'},
            {'key': 'end_time', 'label': 'End Time', 'width': '11%'},
            {'key': 'result', 'label': 'Result', 'width': '8%'}
          ],
          data=processed_rows,
          actions=[
            {
              'type': 'link',
              'key': 'details_url',
              'label': 'Details',
              'class': 'view-link'
            },
            {
              'type': 'link',
              'key': 'history_url',
              'label': 'History',
              'class': 'view-link'
            }
          ],
          empty_message="No logs found.",
          title="Recent Report Runs"
        ) }}
      {% else %}
        {{ table(
          columns=[
            {'key': 'report_name', 'label': 'Report Name', 'width': '8%'},
            {'key': 'description', 'label': 'Description', 'width': '16%'},
            {'key': 'start_time', 'label': 'Start Time', 'width': '11%'},
            {'key': 'end_time', 'label': 'End Time', 'width': '11%'},
            {'key': 'result', 'label': 'Result', 'width': '8%'}
          ],
          data=processed_rows,
          actions=[
            {
              'type': 'link',
              'key': 'details_url',
              'label': 'Details',
              'class': 'view-link'
            }
          ],
          empty_message="No history found.",
          title="Report Run History"
        ) }}
      {% endif %}
    {% else %}
      <div class="alert danger" data-alert>
        <button class="alert-close" data-close-alert>&times;</button>
        No logs found.
      </div>
    {% endif %}

  {% endif %}

</div>

{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Format status cells with icons
    const table = document.querySelector('.data-table');
    if (table) {
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(function(row) {
        const cells = row.querySelectorAll('td');
        cells.forEach(function(cell) {
          const text = cell.textContent.trim().toUpperCase();
          if (text === 'SUCCESS') {
            cell.innerHTML = '<span class="status-badge status-success"><svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>SUCCESS</span>';
          } else if (text === 'FAILED') {
            cell.innerHTML = '<span class="status-badge status-failed"><svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>FAILED</span>';
          }
        });
      });
    }

    // Auto-dismiss alerts after 5 seconds
    const alerts = document.querySelectorAll('[data-alert]');
    alerts.forEach(function(alert) {
      setTimeout(function() {
        dismissAlert(alert);
      }, 5000);
    });

    // Handle close button clicks
    const closeButtons = document.querySelectorAll('[data-close-alert]');
    closeButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const alert = this.closest('[data-alert]');
        dismissAlert(alert);
      });
    });

    function dismissAlert(alert) {
      if (!alert) return;
      alert.classList.add('fade-out');
      setTimeout(function() {
        alert.remove();
      }, 300);
    }
  });
</script>
{% endblock %}
