{% extends 'tags_base.html' %}
{% block title %}Section Tag Mappings{% endblock %}

{% block content %}
<style>
  .container.mt-4 {
    max-width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

  .section-tags-page {
    font-family: 'IBM Plex Sans', sans-serif;
    width: 90vw;
    max-width: 90vw;
    margin: 0 auto;
    padding: 20px 40px 0;
  }

  .page-header {
    position: relative;
    margin-bottom: 30px;
  }

  .page-header-divider {
    width: 4px;
    height: 48px;
    background: #FA4616;
    position: absolute;
    left: 0;
    top: 0;
  }

  .page-title {
    font-family: 'Poppins', sans-serif;
    font-size: 48px;
    font-weight: 700;
    color: #002657;
    margin: 0;
    padding-left: 20px;
    line-height: 48px;
  }

  .filter-section {
    background: white;
    border: none;
    border-radius: 0;
    padding: 0;
    margin-bottom: 24px;
  }

  .filter-section h3 {
    font-family: 'Poppins', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #002657;
    margin: 0 0 20px 0;
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
  }

  .filter-field {
    display: flex;
    flex-direction: column;
  }

  .filter-field label {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
  }

  .filter-field input,
  .filter-field select {
    padding: 10px 12px;
    border: 1px solid #D1D5DB;
    border-radius: 4px;
    font-size: 14px;
    font-family: 'IBM Plex Sans', sans-serif;
    transition: border-color 0.2s ease;
    background: white;
  }

  .filter-field input:focus,
  .filter-field select:focus {
    outline: none;
    border-color: #002657;
  }

  .filter-buttons {
    display: flex;
    align-items: flex-end;
  }

  .filter-actions-inline {
    display: flex;
    gap: 12px;
    width: 100%;
  }

  .btn-filter {
    padding: 10px 24px;
    background: #0021A5;
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
    text-transform: uppercase;
  }

  .btn-filter:hover {
    background: #001580;
  }

  .btn-reset {
    padding: 10px 24px;
    background: #6C757D;
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
    text-transform: uppercase;
    text-decoration: none;
    display: inline-block;
  }

  .btn-reset:hover {
    background: #5A6268;
    color: white;
  }

  .section-heading {
    font-family: 'Poppins', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #002657;
    margin: 32px 0 16px 0;
  }

  .action-bar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .select-all-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .select-all-wrapper input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .select-all-wrapper label {
    font-size: 14px;
    font-weight: 500;
    color: #4A4A4A;
    cursor: pointer;
    margin: 0;
  }

  .btn-delete {
    padding: 10px 24px;
    background: #DC2626;
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
    text-transform: uppercase;
  }

  .btn-delete:hover {
    background: #B91C1C;
  }

  .btn-reset-sort {
    padding: 10px 24px;
    background: #6C757D;
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .btn-reset-sort:hover {
    background: #5A6268;
  }

  .mappings-table-wrapper {
    background: white;
    border-radius: 8px;
    overflow-x: auto;
    overflow-y: visible;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 100%;
  }

  .mappings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    table-layout: fixed;
  }

  .mappings-table thead th:nth-child(1) {
    width: 50px; /* Checkbox */
  }

  .mappings-table thead th:nth-child(2) {
    width: 120px; /* D2L OrgUnitId */
  }

  .mappings-table thead th:nth-child(3) {
    width: 120px; /* Genius Section ID */
  }

  .mappings-table thead th:nth-child(4) {
    width: auto; /* Section Name */
  }

  .mappings-table thead th:nth-child(5) {
    width: 150px; /* Tag Name */
  }

  .mappings-table thead th:nth-child(6) {
    width: 150px; /* Tag Value */
  }

  .mappings-table thead th:nth-child(7) {
    width: 100px; /* Actions */
  }

  .mappings-table thead {
    background: #002657;
  }

  .mappings-table thead th {
    color: #FFFFFF;
    font-weight: 600;
    text-align: left;
    padding: 16px 12px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
  }

  .mappings-table thead th:hover {
    background: #003580;
  }

  .mappings-table thead th span {
    margin-left: 4px;
    opacity: 0.7;
  }

  .mappings-table tbody tr {
    border-bottom: 1px solid #E5E5E5;
  }

  .mappings-table tbody tr:nth-child(even) {
    background: #F9FAFB;
  }

  .mappings-table tbody tr:hover {
    background: #F3F4F6;
  }

  .mappings-table tbody td {
    padding: 14px 12px;
    color: #4A4A4A;
  }

  .mappings-table tbody td:first-child {
    padding-left: 12px;
    text-align: center;
  }

  .mappings-table tbody td input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    margin: 0;
  }

  .mappings-table thead th input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    margin: 0;
  }

  .btn-delete-single {
    background: transparent;
    color: #DC2626;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: background 0.2s ease;
  }

  .btn-delete-single:hover {
    background: #FEE2E2;
  }

  .pagination-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0 0 0;
    margin-top: 20px;
    margin-bottom: 0;
    gap: 12px;
  }

  .pagination-info {
    font-size: 14px;
    color: #6B7280;
    order: 2;
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    order: 1;
  }

  .pagination-btn {
    padding: 8px 16px;
    border: 1px solid #D1D5DB;
    background: white;
    color: #4A4A4A;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .pagination-btn:hover:not(.disabled) {
    background: #F3F4F6;
    border-color: #9CA3AF;
  }

  .pagination-btn.active {
    background: #0021A5;
    color: white;
    border-color: #0021A5;
  }

  .pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .pagination-ellipsis {
    padding: 8px 12px;
    color: #6B7280;
    font-size: 14px;
    user-select: none;
  }

  .no-results {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
    font-size: 16px;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .alert-success {
    background: #D1FAE5;
    color: #065F46;
    border: 1px solid #6EE7B7;
  }

  /* .alert-warning {
  background: #FEF3C7;
  color: #92400E;
  border: 1px solid #FCD34D;
} */


  .alert-danger {
    background: #FEE2E2;
    color: #991B1B;
    border: 1px solid #FCA5A5;}
  
  .btn-back {
    display: inline-block;
    margin-top: 32px;
    padding: 10px 24px;
    background: #0021A5;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 500;
  }

  .btn-back:hover {
    background: #001580;
    color: white;
  }
    
</style>

<div class="section-tags-page">
  <div class="page-header">
    <div class="page-header-divider"></div>
    <h1 class="page-title">View & Remove Tags</h1>
  </div>

  {% if messages %}
    {% for cat, msg in messages %}
      <div class="alert alert-{{ cat }}">
        {{ msg }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Filter Section -->
  <div class="filter-section">
    <h3>Filter Courses</h3>
    <form method="GET" action="{{ base_path }}/section_tags{{ ext }}">
      <div class="filter-grid">
        <div class="filter-field">
          <label>Course Name</label>
          <input type="text" name="name" placeholder="Field value" value="{{ name or '' }}">
        </div>
        <div class="filter-field">
          <label>Course Name -Condition</label>
          <select name="wild_card">
            <option value="">Field value</option>
            <option value="contains" {% if wild_card=='contains' %}selected{% endif %}>Contains</option>
            <option value="begins_with" {% if wild_card=='begins_with' %}selected{% endif %}>Begins With</option>
            <option value="ends_with" {% if wild_card=='ends_with' %}selected{% endif %}>Ends With</option>
            <option value="exact_match" {% if wild_card=='exact_match' %}selected{% endif %}>Exact Match</option>
            <option value="does_not_contain" {% if wild_card=='does_not_contain' %}selected{% endif %}>Does Not Contain</option>
          </select>
        </div>
        <div class="filter-field">
          <label>Genius Section ID</label>
          <input type="text" name="genius_sectionId" placeholder="Field value" value="{{ genius_sectionId or '' }}">
        </div>
        <div class="filter-field">
          <label>D2L Org Unit ID</label>
          <input type="text" name="d2l_OrgUnitId" placeholder="Field value" value="{{ d2l_OrgUnitId or '' }}">
        </div>
      </div>

      <!-- Row 2: Tag Category, Tag Value, Filter/Reset buttons -->
      <div class="filter-grid">
        <div class="filter-field">
          <label>Tag Category</label>
          <select name="tag_name_filter" id="tag_name_filter">
            <option value="">Field value</option>
            {% for tn in unique_tag_names %}
              <option value="{{ tn }}" {% if tag_name_filter == tn %}selected{% endif %}>{{ tn }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-field">
          <label>Tag Value</label>
          <select name="tag_value_filter" id="tag_value_filter">
            <option value="">Field value</option>
          </select>
        </div>
        <div class="filter-field filter-buttons">
          <label>&nbsp;</label>
          <div class="filter-actions-inline">
            <button type="submit" class="btn-filter">FILTER</button>
            <a href="{{ base_path }}/section_tags{{ ext }}" class="btn-reset">RESET</a>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Mappings Section -->
  <form method="POST" action="{{ base_path }}/section_tags{{ ext }}">
    <input type="hidden" name="name" value="{{ name or '' }}">
    <input type="hidden" name="wild_card" value="{{ wild_card or '' }}">
    <input type="hidden" name="tag_name_filter" value="{{ tag_name_filter or '' }}">
    <input type="hidden" name="tag_value_filter" value="{{ tag_value_filter or '' }}">
    <input type="hidden" name="page" value="{{ current_page }}">

    {% if mappings and mappings|length > 0 %}
      <h3 class="section-heading">Remove Tags</h3>
      
      <div class="action-bar">
        <button type="submit" class="btn-delete" onclick="return confirm('Delete selected section tag mappings?');" {% if not can_write %}disabled{% endif %}>
          REMOVE SELECTED TAGS
        </button>
        <div style="color: #6B7280; font-size: 13px; font-style: italic; margin-left: 16px;">
          Note: Removing a tag only removes the association between tables and does not affect the underlying data.
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
          <!-- <label style="font-size: 14px; color: #4A4A4A; margin: 0;">Show</label>
          <select id="rows-per-page" onchange="changeRowsPerPage(this.value)" style="padding: 6px 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" {% if not can_write %}disabled{% endif %}>
 
            <option value="55" {% if per_page == 55 %}selected{% endif %}>55</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if per_page == 200 or per_page == 0 %}selected{% endif %}>200</option>
          </select>
          <label style="font-size: 14px; color: #4A4A4A; margin: 0;">rows</label> -->
        </div>
      </div>
      {% if not can_write %}
        <div style="margin: 10px 0 0 0; color:#6B7280; font-size: 13px; font-style: italic;">
          Read-only account: you can view section tag mappings, but you can’t remove them.
        </div>
      {% endif %}


      <div class="mappings-table-wrapper">
        <table id="tag-mapping-table" class="mappings-table">
          <thead>
            <tr>
              <th data-col="0" style="cursor: default; width: 50px; text-align: center;">
              <input type="checkbox" id="select-all-header" {% if not can_write %}disabled{% endif %}></th>
              <th data-col="1" onclick="sortTable(1)">Genius Section ID<span></span></th>
              <th data-col="2" onclick="sortTable(2)">D2L Org Unit ID<span></span></th>
              <th data-col="3" onclick="sortTable(3)">Section Name<span></span></th>
              <th data-col="4" onclick="sortTable(4)">Tag Category<span></span></th>
              <th data-col="5" onclick="sortTable(5)">Tag Value<span></span></th>
              <th data-col="6" style="cursor: default;">Remove Tag</th>
            </tr>
          </thead>
          <tbody>
            {% for m in mappings %}
              {% set sec_name = m.section_name or m['section_name'] %}
              {% set d2l = m.d2l_OrgUnitId or m['d2l_OrgUnitId'] %}
              {% set sec = m.genius_sectionId or m['genius_sectionId'] %}
              {% set tname = m.tag_name or m['tag_name'] %}
              {% set tval = m.tag_value or m['tag_value'] %}
              {% set entry_id = m.tag_entry_id or m['tag_entry_id'] %}
              {% set combo_id = d2l ~ '_' ~ sec ~ '_' ~ entry_id %}

              <tr>
                <td>
                  <input type="checkbox" class="section-select-checkbox" {% if not can_write %}disabled{% endif %}
                         name="selected_sections"
                         value="{{ combo_id }}">
                </td>
                <td>{{ sec }}</td>
                <td>{{ d2l }}</td>
                <td>{{ sec_name }}</td>
                <td>{{ tname }}</td>
                <td>{{ tval }}</td>
                <td>
                  <button type="submit"
                          name="single_delete"
                          value="{{ combo_id }}"
                          class="btn-delete-single"
                          onclick="return confirm('Delete this section tag mapping?');"
                          title="Remove tag"{% if not can_write %}disabled{% endif %}>
                    <img src="/ufl_tag_manager/assets/link_off.svg" alt="Remove tag" style="width: 20px; height: 20px; vertical-align: middle;">
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if total_pages > 1 %}
        <div class="pagination-wrapper">
          <div class="pagination-controls">
            <a href="{{ base_path }}/section_tags{{ ext }}?page={{ current_page - 1 }}&name={{ name or '' }}&wild_card={{ wild_card or '' }}&d2l_OrgUnitId={{ d2l_OrgUnitId or '' }}&genius_sectionId={{ genius_sectionId or '' }}&tag_name_filter={{ tag_name_filter or '' }}&tag_value_filter={{ tag_value_filter or '' }}" 
               class="pagination-btn {% if current_page == 1 %}disabled{% endif %}">Previous</a>
            
            {# Always show first page #}
            <a href="{{ base_path }}/section_tags{{ ext }}?page=1&name={{ name or '' }}&wild_card={{ wild_card or '' }}&d2l_OrgUnitId={{ d2l_OrgUnitId or '' }}&genius_sectionId={{ genius_sectionId or '' }}&tag_name_filter={{ tag_name_filter or '' }}&tag_value_filter={{ tag_value_filter or '' }}" 
               class="pagination-btn {% if current_page == 1 %}active{% endif %}">1</a>
            
            {# Show ellipsis if gap between first page and start of range #}
            {% if current_page > 4 %}
              <span class="pagination-ellipsis">...</span>
            {% endif %}
            
            {# Show pages around current page #}
            {% for p in range(2, total_pages) %}
              {% if p >= current_page - 2 and p <= current_page + 2 %}
                <a href="{{ base_path }}/section_tags{{ ext }}?page={{ p }}&name={{ name or '' }}&wild_card={{ wild_card or '' }}&d2l_OrgUnitId={{ d2l_OrgUnitId or '' }}&genius_sectionId={{ genius_sectionId or '' }}&tag_name_filter={{ tag_name_filter or '' }}&tag_value_filter={{ tag_value_filter or '' }}" 
                   class="pagination-btn {% if p == current_page %}active{% endif %}">{{ p }}</a>
              {% endif %}
            {% endfor %}
            
            {# Show ellipsis if gap between end of range and last page #}
            {% if current_page < total_pages - 3 %}
              <span class="pagination-ellipsis">...</span>
            {% endif %}
            
            {# Always show last page if there is more than 1 page #}
            {% if total_pages > 1 %}
              <a href="{{ base_path }}/section_tags{{ ext }}?page={{ total_pages }}&name={{ name or '' }}&wild_card={{ wild_card or '' }}&d2l_OrgUnitId={{ d2l_OrgUnitId or '' }}&genius_sectionId={{ genius_sectionId or '' }}&tag_name_filter={{ tag_name_filter or '' }}&tag_value_filter={{ tag_value_filter or '' }}" 
                 class="pagination-btn {% if current_page == total_pages %}active{% endif %}">{{ total_pages }}</a>
            {% endif %}
            
            <a href="{{ base_path }}/section_tags{{ ext }}?page={{ current_page + 1 }}&name={{ name or '' }}&wild_card={{ wild_card or '' }}&d2l_OrgUnitId={{ d2l_OrgUnitId or '' }}&genius_sectionId={{ genius_sectionId or '' }}&tag_name_filter={{ tag_name_filter or '' }}&tag_value_filter={{ tag_value_filter or '' }}" 
               class="pagination-btn {% if current_page == total_pages %}disabled{% endif %}">Next</a>
          </div>
          <div class="pagination-info">
            Showing {{ ((current_page - 1) * 200) + 1 }} to {% if current_page * 200 < total_count %}{{ current_page * 200 }}{% else %}{{ total_count }}{% endif %} of {{ total_count }} entries
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="no-results">No section tag mappings found.</div>
    {% endif %}
  </form>
  <a href="{{ base_path }}/tags_index{{ ext }}" class="btn-back">
    Back to Tag Home
  </a>
</div>

<script>
  const CAN_WRITE = {{ 'true' if can_write else 'false' }};

  function setAll(fromId) {
    var master = document.getElementById(fromId);
    if (!master) return;
    var boxes = document.querySelectorAll('.section-select-checkbox');
    boxes.forEach(function (cb) {
      cb.checked = master.checked;
    });
    master.indeterminate = false;
  }

  function updateSelectAllState() {
    var headerCheckbox = document.getElementById('select-all-header');
    if (!headerCheckbox) return;
    
    var boxes = document.querySelectorAll('.section-select-checkbox');
    var checkedCount = 0;
    var totalCount = boxes.length;
    
    boxes.forEach(function(cb) {
      if (cb.checked) checkedCount++;
    });
    
    if (checkedCount === 0) {
      headerCheckbox.checked = false;
      headerCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
      headerCheckbox.checked = true;
      headerCheckbox.indeterminate = false;
    } else {
      headerCheckbox.checked = false;
      headerCheckbox.indeterminate = true;
    }
  }

  let sortHistory = [];

  function getCellText(row, idx) {
    const td = row.children[idx];
    return (td ? (td.innerText || td.textContent) : '').trim();
  }

  function sortTable(colIdx) {
    const table = document.getElementById('tag-mapping-table');
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows).map((tr, i) => ({ tr, i }));
    let direction = 'asc';
    const prev = sortHistory[0];
    if (prev && prev.col === colIdx && prev.dir === 'asc') direction = 'desc';
    sortHistory.length = 0;
    sortHistory.push({ col: colIdx, dir: direction });
    rows.sort((A, B) => {
      const aRaw = getCellText(A.tr, colIdx);
      const bRaw = getCellText(B.tr, colIdx);

      if (colIdx === 3) {
        const a = aRaw.toLowerCase();
        const b = bRaw.toLowerCase();

        let res = a.localeCompare(b); 
        if (res === 0) res = A.i - B.i;

        return direction === 'asc' ? res : -res; 
      }
      const na = Number(aRaw.replace(/[^0-9.-]/g, ''));
      const nb = Number(bRaw.replace(/[^0-9.-]/g, ''));
      let res;

      if (!isNaN(na) && !isNaN(nb) && aRaw !== '' && bRaw !== '') {
        res = na - nb;
      } else {
        const da = Date.parse(aRaw);
        const db = Date.parse(bRaw);
        if (!isNaN(da) && !isNaN(db)) {
          res = da - db;
        } else {
          res = aRaw.localeCompare(bRaw);
        }
      }
      if (res === 0) res = A.i - B.i;
      return direction === 'asc' ? res : -res;
    });

    // rows.sort((A, B) => {
    //   const a = getCellText(A.tr, colIdx);
    //   const b = getCellText(B.tr, colIdx);
    //   const na = Number(a.replace(/[^0-9.-]/g, ''));
    //   const nb = Number(b.replace(/[^0-9.-]/g, ''));
    //   let res;
    //   if (!isNaN(na) && !isNaN(nb) && a !== '' && b !== '') {
    //     res = na - nb;
    //   } else {
    //     const da = Date.parse(a);
    //     const db = Date.parse(b);
    //     if (!isNaN(da) && !isNaN(db)) {
    //       res = da - db;
    //     } else {
    //       res = a.localeCompare(b);
    //     }
    //   }
    //   if (res === 0) res = A.i - B.i;
    //   return direction === 'asc' ? res : -res;
    // });


    document.querySelectorAll('th[data-col] span').forEach(s => s.textContent = '');
    const th = document.querySelector('th[data-col="' + colIdx + '"]');
    if (th) th.querySelector('span').textContent = direction === 'asc' ? ' ▲' : ' ▼';
    rows.forEach(r => tbody.appendChild(r.tr));
  }

  function buildTagValueMap() {
    const raw = JSON.parse('{{ (tag_values or []) | tojson | safe }}');
    const map = {};
    raw.forEach(function (row) {
      if (!map[row.tag_name]) map[row.tag_name] = [];
      if (!map[row.tag_name].includes(row.tag_value)) {
        map[row.tag_name].push(row.tag_value);
      }
    });
    Object.keys(map).forEach(k => map[k].sort());
    return map;
  }

  function refillTagValueOptions(tagValueMap) {
    const tagNameSel = document.getElementById("tag_name_filter");
    const tagValueSel = document.getElementById("tag_value_filter");
    if (!tagNameSel || !tagValueSel) return;

    const selectedTagName = tagNameSel.value || "";
    const currentValueFromServer = "{{ tag_value_filter | e }}";

    while (tagValueSel.firstChild) tagValueSel.removeChild(tagValueSel.firstChild);

    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "Field value";
    tagValueSel.appendChild(defaultOpt);

    let valuesToShow = [];

    if (selectedTagName && tagValueMap[selectedTagName]) {
      valuesToShow = tagValueMap[selectedTagName];
    } else {
      const set = new Set();
      Object.values(tagValueMap).forEach(arr => arr.forEach(v => set.add(v)));
      valuesToShow = Array.from(set).sort();
    }

    valuesToShow.forEach(val => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      if (currentValueFromServer === val) opt.selected = true;
      tagValueSel.appendChild(opt);
    });
  }

  function changeRowsPerPage(perPage) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1'); 
    window.location.href = url.toString();
  }

  document.addEventListener('DOMContentLoaded', function () {

  if (!CAN_WRITE) {
    var postForm = document.querySelector('form[method="POST"][action="{{ base_path }}/section_tags{{ ext }}"]');
    if (postForm) {
      postForm.addEventListener('submit', function (e) {
        e.preventDefault();
        alert('Read-only account: removing tags is not allowed.');
      });
    }
  }
    var headerCheckbox = document.getElementById('select-all-header');
    if (headerCheckbox) {
      headerCheckbox.addEventListener('change', function () { setAll('select-all-header'); });
    }

    var individualCheckboxes = document.querySelectorAll('.section-select-checkbox');
    individualCheckboxes.forEach(function(cb) {
      cb.addEventListener('change', updateSelectAllState);
    });

    const tagValueMap = buildTagValueMap();
    refillTagValueOptions(tagValueMap);

    const tagNameSel = document.getElementById("tag_name_filter");
    if (tagNameSel) {
      tagNameSel.addEventListener("change", function () {
        const tagValueSel = document.getElementById("tag_value_filter");
        if (tagValueSel) tagValueSel.value = "";
        refillTagValueOptions(tagValueMap);
      });
    }
  });
</script>

{% endblock %}
