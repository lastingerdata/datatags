{% extends "tags_base.html" %}

{% block title %}Add{% endblock %}

{% block content %}
<style>
  .tags-page {
    padding: 40px 60px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 48px;
  }

  .page-header-divider {
    width: 4px;
    height: 60px;
    background: #FA4616;
  }

  .page-title {
    font-family: 'Poppins', sans-serif;
    font-size: 48px;
    font-weight: 700;
    color: #002657;
    margin: 0;
  }

  .add-tag-form {
    background: #FFFFFF;
    padding: 24px;
    border-radius: 8px;
    border: 1px solid #E5E5E5;
    margin-bottom: 48px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 2fr auto;
    gap: 16px;
    align-items: end;
  }

  .form-field label {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #002657;
    margin-bottom: 8px;
    display: block;
  }

  .form-field label .required {
    color: #DC2626;
  }

  .form-field input {
    width: 100%;
    height: 44px;
    padding: 12px 16px;
    border: 1px solid #D1D5DB;
    border-radius: 4px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 14px;
    color: #4A4A4A;
  }

  .form-field input::placeholder {
    color: #9CA3AF;
  }

  .btn-add-tag {
    padding: 12px 32px;
    background: #0021A5;
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    height: 44px;
    white-space: nowrap;
  }

  .btn-add-tag:hover {
    background: #001580;
  }

  .btn-add-tag:disabled {
    background: #6C757D;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .alert {
    position: relative;
    padding-right: 40px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .alert.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
  }

  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
  }

  .alert-close {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    color: inherit;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .alert-close:hover { opacity: 1; }

  .btn-back {
    display: inline-block;
    margin-top: 32px;
    padding: 10px 24px;
    background: #0021A5;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    font-weight: 500;
  }

  .btn-back:hover {
    background: #001580;
    color: white;
  }

  @media (max-width: 768px) {
    .tags-page { padding: 24px 20px; }
    .form-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="tags-page">
  <div class="page-header">
    <div class="page-header-divider"></div>
    <h1 class="page-title">Manage Tag Categories</h1>
  </div>

  {% if messages %}
    {% for cat, msg in messages %}
      <div class="alert {{ 'alert-danger' if cat == 'danger' else 'alert-success' }} py-2 mb-3" data-alert>
        {{ msg }}
        <button class="alert-close" data-close-alert aria-label="Close">&times;</button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="add-tag-form">
    <form method="POST" action="{{ base_path }}/tags{{ ext }}">
      <input type="hidden" name="action" value="add">

      <div class="form-grid">
        <div class="form-field">
          <label for="tag_name">Tag name<span class="required">*</span></label>
          <!-- <input id="tag_name" name="tag_name" type="text" placeholder="Tag name" required> -->
          <input id="tag_name" name="tag_name" type="text" placeholder="Tag name" required {% if not can_write %}disabled{% endif %}>

        </div>

        <div class="form-field">
          <label for="description">Description (optional)</label>
          <!-- <input id="description" name="description" type="text" placeholder="Short description"> -->
          <input id="description" name="description" type="text" placeholder="Short description" {% if not can_write %}disabled{% endif %}>

        </div>

        <div class="form-field">
          <!-- <button type="submit" class="btn-add-tag">Add Tag</button> -->
          <button type="submit" class="btn-add-tag" {% if not can_write %}disabled title="Read-only account"{% endif %}>
            Add Tag
            </button>

        </div>
      </div>
    </form>
    {% if not can_write %}
     <p class="text-muted mt-2">Read-only account: you can view tags, but you canâ€™t add or delete them.</p>
     {% endif %}

  </div>

  {% from 'components/table/table.html' import table %}

  {% if tags and tags|length > 0 %}
    {% set processed_tags = [] %}
    {% for t in tags %}
      {% set _ = processed_tags.append({
        'id': t.tag_id or t.id,
        'tag_name': t.tag_name,
        'description': t.description if t.description else 'No description',
        'tag_id': t.tag_id or t.id,
        'tag_name_hidden': t.tag_name
      }) %}
    {% endfor %}

    {{ table(
      columns=[
        {'key': 'tag_name', 'label': 'Tag Name', 'width': '30%'},
        {'key': 'description', 'label': 'Tag Description', 'width': '55%'}
      ],
      data=processed_tags,
      actions=(
        [
          {
            'type': 'button',
            'action': 'delete',
            'icon': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            'class': 'action-link-delete',
            'title': 'Delete'
          }
        ] if can_write else []
      ),
      empty_message="No tags found.",
      title="Existing Tags"
    ) }}
  {% else %}
    <p class="text-muted">No tags found.</p>
  {% endif %}

  <a href="{{ base_path }}/tags_index{{ ext }}" class="btn-back">
    Back to Tag Home
  </a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const CAN_WRITE = {{ 'true' if can_write else 'false' }};

  function deleteTag(tagId, tagName) {
    if (!CAN_WRITE) {
      alert('Read-only account: you cannot delete tags.');
      return;
    }
    if (!confirm('Are you sure you want to delete the tag "' + tagName + '"?')) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ base_path }}/tags{{ ext }}';

    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'delete';

    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'tag_id';
    idInput.value = tagId;

    const nameInput = document.createElement('input');
    nameInput.type = 'hidden';
    nameInput.name = 'tag_name';
    nameInput.value = tagName;

    form.appendChild(actionInput);
    form.appendChild(idInput);
    form.appendChild(nameInput);

    document.body.appendChild(form);
    form.submit();
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (window.location.search.includes('m=')) {
      const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }

    const addForm = document.querySelector('.add-tag-form form');
    const submitBtn = addForm ? addForm.querySelector('.btn-add-tag') : null;

    if (addForm && submitBtn) {
      if (!CAN_WRITE) {
        addForm.addEventListener('submit', function(e) {
          e.preventDefault();
          alert('Read-only account: you cannot add tags.');
          return false;
        });
      }else{
      addForm.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ADDING...';
        submitBtn.style.opacity = '0.6';
        return true;
      });
    }
  }

    // Handle delete button clicks (calls global deleteTag)
    if(CAN_WRITE){
    document.querySelectorAll('button[data-action="delete"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        if (!row) return;

        const idEl = row.querySelector('[data-tag-id]');
        const nameEl = row.querySelector('[data-tag-name]');

        const tagId = idEl ? idEl.dataset.tagId : '';
        const tagName = nameEl ? nameEl.dataset.tagName : tagId;

        if (!tagId) return;

        deleteTag(tagId, tagName);
      });
    });
  }

    // Auto-dismiss alerts after 5 seconds
    const alerts = document.querySelectorAll('[data-alert]');
    alerts.forEach(function(alert) {
      setTimeout(function() {
        dismissAlert(alert);
      }, 10000);
    });

    // Handle close button clicks
    const closeButtons = document.querySelectorAll('[data-close-alert]');
    closeButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const alert = this.closest('[data-alert]');
        dismissAlert(alert);
      });
    });

    function dismissAlert(alert) {
      if (!alert) return;
      alert.classList.add('fade-out');
      setTimeout(function() {
        alert.remove();
      }, 300);
    }
  });
</script>
{% endblock %}
